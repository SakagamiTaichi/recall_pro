# RecallPro - 暗記カードアプリ仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
RecallPro（リコールプロ）

### 1.2 目的
開発者自身の英語学習を支援するための暗記カードアプリケーション。日本語を見て英語に翻訳する練習を効率的に行い、科学的な復習スケジュールに基づいて長期記憶を促進する。

### 1.3 技術スタック
- **フロントエンド**: Flutter
- **バックエンド**: Firebase（無料枠内での利用を想定）
  - Firebase Authentication（匿名認証）
  - Cloud Firestore（データ保存・同期）
  - Firebase Storage（必要に応じて）
- **プラットフォーム**: Android（当面）
- **音声合成**: AndroidのTTS（Text-to-Speech）

### 1.4 開発方針
- 個人利用を前提とした機能設計
- Firebaseの無料枠内での運用
- シンプルで使いやすいUI/UX
- オフライン対応は必須ではないが、基本的な閲覧は可能にする

---

## 2. コアコンセプト

### 2.1 学習フロー
```
カードセット選択 → カード学習開始 → 問題表示（表面）→ 回答入力
→ 正解表示（裏面）→ 音声再生 → 自己評価（○×△）→ 次のカード
```

### 2.2 間隔反復学習（SRS: Spaced Repetition System）
エビングハウスの忘却曲線に基づいた復習スケジュールを採用。初期段階では短い間隔で繰り返し出題することで定着を促進する。

**復習間隔ルール:**
- **○（正解）時の復習間隔**: 段階的に延長
  - 1回目: 1分後（同セッション内）
  - 2回目: 10分後（同セッション内）
  - 3回目: 1時間後
  - 4回目: 12時間後
  - 5回目: 1日後
  - 6回目: 3日後
  - 7回目: 7日後
  - 8回目: 14日後
  - 9回目: 30日後
  - 10回目以降: 60日後
- **△（やや正解）**: 現在の間隔を短縮
  - 現在の間隔の50%で再出題
  - ただし、レベルは維持（降格しない）
- **×（不正解）**: 最初からやり直し
  - レベル0に戻り、1分後に再出題
  - 同セッション内で即座に「要復習」キューに追加

**学習セッション内での挙動:**
- 1分後・10分後の復習は同じセッション内で自動的に出題される
- セッション終了時に未完了の短期復習がある場合は通知を表示
- 次回セッション開始時には、すべての期限切れ復習カードが出題される

---

## 3. データモデル

### 3.1 CardSet（カードセット）
```
{
  id: string,
  title: string,
  description: string,
  createdAt: timestamp,
  updatedAt: timestamp,
  cardCount: number,
  userId: string
}
```

### 3.2 Card（カード）
```
{
  id: string,
  cardSetId: string,
  front: string,          // 日本語（問題）
  back: string,           // 英語（解答）
  createdAt: timestamp,
  updatedAt: timestamp,
  order: number           // カードセット内の順序
}
```

### 3.3 LearningProgress（学習進捗）
```
{
  id: string,
  userId: string,
  cardId: string,
  cardSetId: string,
  level: number,          // 習熟レベル（0〜10）
  nextReviewDate: timestamp,
  lastReviewedAt: timestamp,
  reviewCount: number,
  correctCount: number,
  incorrectCount: number,
  partialCount: number,   // △の回数
  easeFactor: float       // 難易度係数（将来的な拡張用）
}
```

### 3.4 StudySession（学習セッション）
```
{
  id: string,
  userId: string,
  cardSetId: string,
  startedAt: timestamp,
  endedAt: timestamp?,
  cardsStudied: number,
  correctCount: number,
  incorrectCount: number,
  partialCount: number
}
```

---

## 4. 機能要件

### 4.1 カードセット管理

#### 4.1.1 カードセット一覧
- 作成した全カードセットを一覧表示
- 各カードセットに以下の情報を表示:
  - タイトル
  - カード総数
  - 今日復習すべきカード数
  - 学習進捗率（習得済み/全体）
  - 最終学習日時

#### 4.1.2 カードセット作成
- タイトル入力（必須）
- 説明文入力（任意）
- 作成後、カード追加画面へ遷移

#### 4.1.3 カードセット編集
- タイトル・説明の編集
- カードセットの削除（確認ダイアログ表示）

#### 4.1.4 カードセット検索・フィルタ
- タイトルでの部分一致検索
- フィルタ条件:
  - すべて
  - 今日復習すべきカードがあるセット
  - 未学習のカードがあるセット
  - 最近学習したセット

### 4.2 カード管理

#### 4.2.1 カード一覧
- カードセット内の全カードをリスト表示
- 各カードに以下の情報を表示:
  - 表面（日本語）のプレビュー
  - 習得状態（アイコンまたはラベル）
  - 次回復習日

#### 4.2.2 カード作成
- 表面（日本語）入力
- 裏面（英語）入力
- 複数カードの連続作成機能

#### 4.2.3 カード編集
- 表面・裏面の編集
- カードの削除（確認ダイアログ表示）
- カードの並び替え（ドラッグ&ドロップまたは順序番号指定）

#### 4.2.4 カード検索
- 表面・裏面の内容での部分一致検索
- 習得状態でのフィルタリング:
  - すべて
  - 未学習
  - 学習中
  - 習得済み
  - 要復習

### 4.3 学習機能

#### 4.3.1 学習セッション開始
- カードセット選択時に学習ボタン表示
- 学習モードの選択:
  - **復習モード**: 復習予定日が今日以前のカードのみ（復習予定日が古い順に出題）
  - **新規学習モード**: 未学習のカードのみ（カードの順序順に出題）
  - **すべて練習モード**: すべてのカード（復習予定日が古い順→未学習カード順）

**カード出題順序:**
- 復習予定カードは `nextReviewDate` の古い順に出題
- 同じセッション内での短期復習（1分後、10分後）は、その時刻になったら割り込んで出題
- 短期復習カードは元の出題順序には影響しない（別キューで管理）

#### 4.3.2 学習画面（問題表示）
- 上部: 進捗バー（現在のカード番号/総カード数）
- 中央: 問題（日本語）を大きく表示
- 下部: 回答入力エリア（複数行テキスト入力）
- 「解答を確認」ボタン

#### 4.3.3 学習画面（解答確認）
- 問題（日本語）
- 自分の回答
- 正解（英語）
- 音声再生ボタン（TTS使用）
  - タップで英語の正しい発音を再生
  - 自動再生オプション（設定で有効/無効切替）
- 自己評価ボタン:
  - **×（不正解）**: 赤色、「もう一度」
  - **△（やや正解）**: 黄色、「だいたい合ってた」
  - **○（正解）**: 緑色、「完璧！」
- 評価選択後、次のカードへ自動遷移

#### 4.3.4 学習完了画面
- セッションの統計表示:
  - 学習時間
  - カード数
  - ○/△/×の内訳
  - 正答率
- 「セットに戻る」ボタン
- 「もう一度学習」ボタン

### 4.4 音声再生機能

#### 4.4.1 TTS設定
- Android標準のTTSエンジンを使用
- 言語: 英語（en-US）
- 速度: 通常（設定で調整可能）
- ピッチ: 標準

#### 4.4.2 再生制御
- 解答確認画面での手動再生
- 設定で自動再生の有効/無効を切替可能
- 再生中の停止機能

### 4.5 同期機能

#### 4.5.1 データ同期
- Cloud Firestoreを使用した自動同期
- 変更があった際にバックグラウンドで同期
- 複数デバイス間でのリアルタイム同期

#### 4.5.2 競合解決
- タイムスタンプベースで最新データを優先
- ローカルキャッシュの活用

### 4.6 統計・進捗管理

#### 4.6.1 全体統計
- 総学習時間
- 総学習カード数
- 総カードセット数
- 習得済みカード数

#### 4.6.2 カードセット別統計
- 学習進捗率（%）
- 習得済み/学習中/未学習の内訳
- 平均正答率
- 最終学習日時

---

## 5. 非機能要件

### 5.1 パフォーマンス
- アプリ起動: 3秒以内
- 画面遷移: 1秒以内
- カード表示: 即座（100ms以内）
- 同期処理: バックグラウンドで実施

### 5.2 セキュリティ
- Firebase Authenticationによる匿名認証
- Firestoreのセキュリティルールでユーザーデータを保護
- 個人利用のため、高度なセキュリティは不要

### 5.3 可用性
- オフライン時もローカルキャッシュで基本機能を利用可能
- ネットワーク復帰時に自動同期

### 5.4 保守性
- Flutterのクリーンアーキテクチャ採用
- Providerまたはriverpod等での状態管理
- コードの可読性とメンテナンス性を重視

---

## 6. UI/UX設計方針

### 6.1 デザイン原則
- **シンプル**: 機能は必要最小限に絞る
- **直感的**: 操作方法が一目でわかる
- **高速**: ストレスなく学習できる
- **モチベーション維持**: 進捗が見えやすい

### 6.2 画面構成
```
1. ホーム画面
   - カードセット一覧
   - 今日の復習カード数表示
   - 新規カードセット作成ボタン

2. カードセット詳細画面
   - カード一覧
   - 統計情報
   - 学習開始ボタン
   - カード追加ボタン

3. 学習画面
   - 問題表示モード
   - 解答確認モード

4. 設定画面
   - TTS設定
   - 学習設定（自動再生など）
   - データ管理（エクスポート/インポート）
```

### 6.3 カラースキーム
- **正解（○）**: 緑系（#4CAF50）
- **やや正解（△）**: 黄色系（#FFC107）
- **不正解（×）**: 赤系（#F44336）
- **プライマリ**: 青系（現在のテーマに準拠）
- **背景**: 白/ダークモード対応

---

## 7. Firebase構成

### 7.1 Firestore コレクション構造
```
/users/{userId}
  - email: string (optional)
  - createdAt: timestamp

/users/{userId}/cardSets/{cardSetId}
  - カードセット情報

/users/{userId}/cardSets/{cardSetId}/cards/{cardId}
  - カード情報

/users/{userId}/learningProgress/{cardId}
  - 学習進捗情報

/users/{userId}/studySessions/{sessionId}
  - 学習セッション記録
```

### 7.2 セキュリティルール
```
match /users/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;

  match /cardSets/{cardSetId} {
    allow read, write: if request.auth != null && request.auth.uid == userId;

    match /cards/{cardId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }

  match /learningProgress/{cardId} {
    allow read, write: if request.auth != null && request.auth.uid == userId;
  }

  match /studySessions/{sessionId} {
    allow read, write: if request.auth != null && request.auth.uid == userId;
  }
}
```

### 7.3 インデックス設定
- `learningProgress`: `nextReviewDate` の昇順インデックス
- `cards`: `cardSetId` + `order` の複合インデックス
- `studySessions`: `startedAt` の降順インデックス

---

## 8. 開発フェーズ

### Phase 1: 基本機能（MVP）
- [ ] Firebase設定とプロジェクト初期化
- [ ] 匿名認証実装
- [ ] カードセットCRUD機能
- [ ] カードCRUD機能
- [ ] 基本的な学習フロー（問題→回答→評価）
- [ ] SRS（間隔反復）アルゴリズム実装

### Phase 2: 学習体験の向上
- [ ] TTS（音声再生）機能実装
- [ ] 学習統計画面
- [ ] カード検索・フィルタ機能
- [ ] 学習セッション記録

### Phase 3: データ管理と同期
- [ ] 複数デバイス間の同期
- [ ] オフライン対応の強化
- [ ] データバックアップ機能

### Phase 4: UX改善
- [ ] アニメーション追加
- [ ] ダークモード対応
- [ ] ウィジェット（今日の復習カード数表示）
- [ ] 通知機能（復習リマインダー）

---

## 9. 技術的な考慮事項

### 9.1 状態管理
- **推奨**: Riverpod または Provider
- ローカルステートとグローバルステートの明確な分離

### 9.2 短期復習の実装
- **セッション内キュー管理**:
  - メインキュー: 通常の復習予定カード（復習予定日順）
  - 短期復習キュー: 1分後・10分後の復習カード（時刻順）
- **タイマー管理**:
  - カード評価後、○の場合は現在時刻＋間隔を計算
  - セッション進行中、定期的に短期復習キューをチェック
  - 時刻が来たカードを優先的に出題
- **セッション終了時**:
  - 未完了の短期復習がある場合は警告表示
  - オプション: 「短期復習を完了してから終了」または「そのまま終了」

### 9.3 データ永続化
- **オンライン**: Cloud Firestore
- **オフライン**: FlutterのローカルDB（sqflite または hive）
- 同期戦略: オプティミスティックUI更新

### 9.4 TTS実装
- パッケージ: `flutter_tts`
- プラットフォーム固有の設定（Android）
- エラーハンドリング（TTS利用不可時の対処）

### 9.5 テスト戦略
- ユニットテスト: ビジネスロジック（SRSアルゴリズムなど）
- ウィジェットテスト: UI コンポーネント
- 統合テスト: 主要な学習フロー

---

## 10. 将来的な拡張案

### 10.1 機能拡張
- CSV/Excelでのカードインポート/エクスポート
- 画像付きカード
- 音声録音機能（自分の発音を録音して比較）
- カテゴリ・タグ機能
- 共有機能（カードセットを他ユーザーと共有）

### 10.2 プラットフォーム拡張
- iOS版の開発
- Web版の開発
- デスクトップ版（Windows/Mac/Linux）

### 10.3 学習機能強化
- より高度なSRSアルゴリズム（Anki方式）
- 学習リマインダー通知
- 達成バッジ・ゲーミフィケーション
- 学習時間の目標設定

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| SRS | Spaced Repetition System（間隔反復学習システム） |
| TTS | Text-to-Speech（テキスト読み上げ） |
| エビングハウスの忘却曲線 | 時間経過による記憶の保持率を示す曲線 |
| カードセット | 複数のカードをまとめたグループ |
| 習熟レベル | カードの習得度合いを示す指標（0〜10） |
| 復習間隔 | 次回の復習までの期間 |
| 短期復習 | セッション内で行う1分後・10分後の復習 |
| 復習キュー | 復習予定のカードを管理する優先度付きキュー |

---

## 12. 参考資料

- [エビングハウスの忘却曲線](https://ja.wikipedia.org/wiki/忘却曲線)
- [間隔反復学習](https://ja.wikipedia.org/wiki/間隔反復)
- [Anki - 間隔反復学習ソフトウェア](https://apps.ankiweb.net/)
- [Flutter TTS Plugin](https://pub.dev/packages/flutter_tts)
- [Firebase for Flutter](https://firebase.google.com/docs/flutter/setup)

---

**文書バージョン**: 1.0
**最終更新日**: 2026-01-25
**作成者**: Development Team
